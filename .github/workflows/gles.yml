name: Build LWJGL3 Android GLES

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 8
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Create Build Script
        run: |
          # 这里将下方的脚本内容写入本地文件
          cat << 'EOF' > build_android.sh
          #!/bin/bash
          set -e

          # 1. 环境定义
          export LWJGL_BUILD_ARCH=arm64
          export ANDROID=1
          export LWJGL_BUILD_OFFLINE=1
          export LIBFFI_VERSION=3.4.6
          export NDK_ABI=arm64-v8a
          export NDK_TARGET=aarch64
          export TARGET=aarch64-linux-android
          
          # 定位 NDK 工具链 (GitHub 环境默认路径)
          NDK_PATH=$ANDROID_SDK_ROOT/ndk/$(ls $ANDROID_SDK_ROOT/ndk | sort -V | tail -n 1)
          TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin
          export PATH=$TOOLCHAIN:$PATH

          # 定义编译器
          export CC=$TOOLCHAIN/${TARGET}21-clang
          export CXX=$TOOLCHAIN/${TARGET}21-clang++
          LWJGL_NATIVE=bin/libs/native/linux/$LWJGL_BUILD_ARCH/org/lwjgl
          mkdir -p $LWJGL_NATIVE

          # 2. 编译 libffi
          if [ ! -d libffi ]; then
            wget https://github.com/libffi/libffi/releases/download/v$LIBFFI_VERSION/libffi-$LIBFFI_VERSION.tar.gz
            tar xvf libffi-$LIBFFI_VERSION.tar.gz
            mv libffi-$LIBFFI_VERSION libffi
          fi
          cd libffi
          [ -f Makefile ] && make distclean || true
          bash configure --host=$TARGET --enable-static=yes --enable-shared=no CC=$CC CXX=$CXX
          make -j4
          # 精准定位并拷贝 libffi.a
          LIBFFI_A=$(find . -name "libffi.a" | grep ".libs" | head -n 1)
          cd ..
          cp libffi/$LIBFFI_A $LWJGL_NATIVE/
          echo "libffi.a 已就绪"

          # 3. 准备编译参数 (针对 NDK 27/Clang 18)
          FIX_FLAGS="-std=gnu89 -Wno-error -Wno-strict-prototypes -Wno-implicit-const-int-float-conversion -lm"

          # 4. 执行 Ant 编译 (核心逻辑)
          ant -Dplatform.linux=true \
            -Dlwjgl.modules=core,egl,opengles \
            -Dbinding.core=true \
            -Dbinding.egl=true \
            -Dbinding.opengles=true \
            -Dbinding.opengl=false \
            -Dbinding.glfw=false \
            -Dbuild.type=release/3.3.3 \
            -Djavadoc.skip=true \
            -Dcompiler.linux.cc=$CC \
            -Dcompiler.linux.cxx=$CXX \
            -Dcompiler.linux.cflags="$FIX_FLAGS" \
            -Dcompiler.linux.linkerflags="$FIX_FLAGS" \
            compile-templates compile compile-native release

          # 5. 提取产物
          mkdir -p bin/out
          find bin/libs/native -name 'liblwjgl.so' -exec cp {} bin/out/ \;
          find bin/libs/native -name 'liblwjgl_opengles.so' -exec cp {} bin/out/ \;
          EOF

      - name: Run Build Script
        run: bash build_android.sh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lwjgl-android-gles-arm64
          path: bin/out/
